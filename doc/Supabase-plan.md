Okay, here is a dedicated Supabase Specific Development Plan, consolidating and emphasizing the crucial workflows and best practices for interacting with the Supabase platform throughout the AppraisalHub project lifecycle. This acts as a central reference guide for all Supabase-related activities.

---

## AppraisalHub: Supabase Specific Development Plan

**Version:** 1.0
**Date:** 2024-03-04

**1. Introduction & Goals**

This document outlines the specific plans, workflows, and best practices for utilizing the Supabase platform within the AppraisalHub project. It consolidates Supabase-centric guidelines from the frontend and backend plans to provide a focused reference for developers and operations.

**Primary Goals:**

*   Ensure consistent, reliable, and secure use of Supabase features (Database, Auth, Functions, Storage, etc.).
*   Prevent common pitfalls related to migrations, client configuration, security, and deployment.
*   Maximize developer productivity and minimize friction when working with Supabase tools and services.
*   Establish clear procedures for managing Supabase environments, schema changes, and deployments.

**2. Core Philosophy for Supabase Usage**

*   **Local-First Development:** Prioritize using the Supabase CLI and local instance (`supabase start`) for development and initial testing.
*   **Migration-Driven Schema:** ALL database schema changes (tables, columns, types, RLS, functions, triggers, indices) MUST be managed via timestamped migration files generated by `supabase db diff`.
*   **Declarative Security:** Define security primarily through Row Level Security (RLS) policies managed via migrations.
*   **Least Privilege:** Apply the principle of least privilege for API keys (`Anon` vs. `Service Role`) and database roles.
*   **Centralized Configuration:** Manage secrets and environment-specific settings through designated Supabase mechanisms (`supabase secrets`, environment variables).

**3. Environment Management**

*   **Separate Projects:** Maintain distinct Supabase projects for `development` (or `staging`) and `production`. **Never use the development project for production data or traffic.**
*   **Local Environment (`supabase start`):**
    *   Use as the primary development environment.
    *   Utilize local Supabase Studio (`localhost:54323`) and direct DB connections (`localhost:54322`) for *making* changes, but always capture these changes via `supabase db diff`.
    *   Use `supabase db reset` frequently to validate the entire migration history.
*   **Linking:** Use `supabase link --project-ref <ref>` primarily to associate the local CLI with the *development* project for initial setup or pulling specific remote changes (use cautiously). Production interactions should ideally be scripted via CI/CD using access tokens.
*   **Environment Variables:** Configure Supabase URLs and Keys via appropriate environment variables (frontend framework `.env.local`, backend `supabase secrets` / `.env` for local).

**4. Database & Migration Workflow (**CRITICAL**)**

*   **Authoritative Source:** The `supabase/migrations/` directory contains the canonical history of the database schema.
*   **Mandatory Workflow:**
    1.  Make schema changes on the *local* Supabase instance (via SQL client, local Studio).
    2.  Immediately generate a migration file: `supabase db diff > supabase/migrations/$(date +%Y%M%d%H%M%S)_descriptive_name.sql`.
    3.  Briefly review the generated SQL for correctness.
    4.  **Validate locally:** `supabase db reset`. Fix the migration file if reset fails and repeat `db reset` until successful.
    5.  Commit the validated migration file to Git.
*   **RLS Policy Implementation:** Create RLS policies (`CREATE POLICY...`) within migration files. Ensure the policy migration timestamp is *later* than the migration creating the referenced table/columns. Test RLS thoroughly with `pgTAP`.
*   **DB Functions/Triggers/Indices:** Define entirely within migration files. Test with `pgTAP`.
*   **No Manual Edits:** **NEVER** manually edit migration files that have already been applied (locally or remotely). Create a *new* migration to make corrections or further changes.
*   **Rollback Planning:** For complex/risky migrations, document rollback steps and create/test manual "down" migration scripts locally *before* applying to production.

**5. Authentication & Authorization (RLS)**

*   **Primary Mechanism:** RLS is the core authorization layer. Design policies carefully to enforce data access rules based on `auth.uid()`, roles, status, etc.
*   **Policy Management:** Define ALL RLS policies via SQL in migration files.
*   **Testing:** Write comprehensive RLS tests using `pgTAP` (`supabase test db`). Test various user roles and scenarios.
*   **JWT Verification:** Edge Functions requiring authentication MUST verify the incoming JWT and extract the `user.id` for context and authorization checks (often implicitly used by RLS in subsequent DB queries).

**6. Edge Functions**

*   **Development:** Use `supabase functions serve` for local development and testing. Leverage Deno's testing framework.
*   **Security:**
    *   Verify JWTs for protected functions.
    *   Implement strict input validation (Zod recommended).
    *   Access secrets *only* via `Deno.env.get()`.
    *   Use `SERVICE_ROLE_KEY` with extreme caution, only when RLS bypass is essential, document the rationale in an ADR, and implement rigorous manual authorization checks within the function.
*   **Configuration:** Pass Supabase URL and relevant Key (`ANON_KEY` or `SERVICE_ROLE_KEY`) via secrets accessed by `Deno.env.get()`.
*   **Logging:** Implement **structured JSON logging** for better observability.
*   **Deployment:** Deploy via `supabase functions deploy <function_name>` (ideally scripted in CI/CD). Ensure functions are deployed *after* any dependent DB migrations.

**7. Storage**

*   **Bucket Creation:** Define bucket creation within migrations (using Supabase helper functions if needed, or manage via dashboard initially and ensure consistent naming).
*   **Access Policies:** Define storage access policies primarily using Supabase Storage RLS capabilities, managed via SQL within migration files (`CREATE POLICY ... ON storage.objects ...`). Test these policies.

**8. Secrets Management (**CRITICAL**)**

*   **Single Source:** Use `supabase secrets set SECRET_NAME=value` for ALL backend secrets needed by Edge Functions (Supabase keys, external API keys, service account keys).
*   **Access:** `Deno.env.get('SECRET_NAME')` within Edge Functions.
*   **Local Development:** Secrets are available via `supabase start`. Alternatively use a `.env` file in `supabase/` (gitignored).
*   **Security:** **NEVER** commit secrets or `.env` files containing secrets to Git. Periodically review secrets for necessity.

**9. Supabase Client Usage**

*   **Frontend:**
    *   Single canonical instance (`src/lib/supabase.ts`).
    *   Initialized *only* with `NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY` from framework environment variables.
    *   Imported by all components/hooks/services needing it.
*   **Backend (Edge Functions):**
    *   Instantiated *within* the function scope (or shared backend helper).
    *   Initialized *only* with `SUPABASE_URL` / `SUPABASE_ANON_KEY` (or `SUPABASE_SERVICE_ROLE_KEY`) accessed via `Deno.env.get()` (sourced from `supabase secrets`).

**10. Testing Strategy (Supabase Focus)**

*   **Migration Validation:** `supabase db reset` locally is the primary test that the full migration history is correct.
*   **Database/RLS Testing:** `pgTAP` (`supabase test db`) is mandatory for testing RLS policies, DB functions, triggers, and complex constraints.
*   **Function Testing:** Use `supabase functions serve` for local integration testing. Use Deno test runner for unit tests.

**11. Deployment Workflow (CI/CD)**

*   **Strict Order:**
    1.  Run all tests (lint, unit, integration, DB/pgTAP).
    2.  Apply Database Migrations to target environment (`supabase migration up`). Requires Supabase Access Token.
    3.  Deploy Edge Functions to target environment (`supabase functions deploy`). Requires Supabase Access Token.
    4.  (Frontend deployment via Lovable/GitHub sync happens separately/concurrently).
*   **Automation:** Script these steps in GitHub Actions (or chosen CI/CD tool).
*   **Environment Targeting:** Use `--project-ref` flag or environment variables in CI/CD scripts to target the correct Supabase project (staging/production).

**12. Logging & Monitoring**

*   **Leverage Supabase Dashboard:** Utilize built-in Logs (Database, Functions, Auth) and Usage reports.
*   **Enhance with Integrations:** Set up log drains (e.g., to Logflare, Better Stack) for better searchability, retention, and analysis of backend (especially function) logs. Integrate error tracking (Sentry).
*   **Structured Logging:** Ensure Edge Functions output structured JSON logs to facilitate analysis in integrated tools.

**13. Operations & Maintenance (Supabase Focus)**

*   **Backups:** Configure and regularly test database backups (Point-in-Time Recovery recommended for production).
*   **Updates:** Keep Supabase CLI version up-to-date. Monitor Supabase platform announcements for relevant changes.
*   **Resource Monitoring:** Monitor database, function, storage, and auth usage via the Supabase dashboard and billing section. Adjust compute resources as needed.
*   **Cost Management:** Track Supabase costs and related cloud provider costs (e.g., egress, Gemini).

**14. Advanced/Optional Supabase Features**

*   **`pg_cron`:** Use for database-centric scheduled tasks defined via migrations.
*   **Realtime:** If used, implement listeners securely on the frontend and manage related RLS policies carefully. Test thoroughly.

**15. Conclusion**

This plan establishes the essential rules and workflows for interacting with Supabase throughout the AppraisalHub project. Consistent adherence to these guidelines, particularly regarding migrations, secrets management, client usage, security (RLS), and deployment order, is crucial for building a stable, secure, and maintainable application on the Supabase platform.